name: Integration Tests

on:
  push:
    branches: [master]
  pull_request:

concurrency:
  group: integration-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.26.0'

jobs:
  get-versions:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Build version matrix
        id: set-matrix
        run: |
          # Read the versions file and build matrix combining pinned + latest
          # Cross with unary-server on/off to test both configurations
          VERSIONS=$(jq -c '[.pinned[], .latest] | unique' integration/baml_versions.json)
          echo "matrix={\"baml-version\":$VERSIONS,\"unary-server\":[false,true]}" >> $GITHUB_OUTPUT

  integration-tests:
    needs: get-versions
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.get-versions.outputs.matrix) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Integration Tests (BAML ${{ matrix.baml-version }}, unary=${{ matrix.unary-server }})
        env:
          BAML_VERSION: ${{ matrix.baml-version }}
          UNARY_SERVER: ${{ matrix.unary-server }}
        # -p 1 ensures tests run sequentially (no parallelism) since integration tests
        # share state (server config, worker pool) that could cause flakiness if parallel
        run: go test -tags=integration -v -count=1 -p 1 -timeout 40m ./integration/...

  integration-tests-baml-source:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        unary-server: [false, true]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Read BAML source commit
        id: baml-source
        run: echo "commit=$(jq -r '.source' integration/baml_versions.json)" >> "$GITHUB_OUTPUT"

      - name: Checkout BAML Source
        uses: actions/checkout@v6
        with:
          repository: BoundaryML/baml
          ref: ${{ steps.baml-source.outputs.commit }}
          path: baml-source

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Integration Tests (BAML Source, unary=${{ matrix.unary-server }})
        env:
          BAML_SOURCE: ${{ github.workspace }}/baml-source
          UNARY_SERVER: ${{ matrix.unary-server }}
        run: go test -tags=integration -v -count=1 -p 1 -timeout 40m ./integration/...
