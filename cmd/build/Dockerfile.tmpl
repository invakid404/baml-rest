{{- if .bamlSource }}
# Rust builder stage: Build BAML CFFI library and CLI from source
FROM rust:bookworm AS cffi-builder

# Install Go (needed for protoc-gen-go during CFFI build)
ARG TARGETARCH
RUN apt-get update && \
    apt-get install -y wget && \
    wget -q https://go.dev/dl/go1.25.6.linux-${TARGETARCH}.tar.gz && \
    tar -C /usr/local -xzf go1.25.6.linux-${TARGETARCH}.tar.gz && \
    rm go1.25.6.linux-${TARGETARCH}.tar.gz && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

ENV PATH="/usr/local/go/bin:/go/bin:${PATH}"
ENV GOPATH="/go"

# Install protoc-gen-go (needed by CFFI build.rs for Go protobuf generation)
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@{{ .protocGenGoVersion }}

# Copy engine source
COPY baml_engine /baml_engine

# Build CFFI library and CLI
WORKDIR /baml_engine
RUN cargo build --release -p baml-cli -p baml_cffi

{{- end }}

# Builder stage: Node.js + Go combined environment
FROM node:22-bookworm AS builder

# Install Go (multi-architecture support)
ARG TARGETARCH{{ if .defaultTargetArch }}={{ .defaultTargetArch }}{{ end }}
RUN apt-get update && \
    apt-get install -y wget git ca-certificates && \
    wget -q https://go.dev/dl/go1.25.6.linux-${TARGETARCH}.tar.gz && \
    tar -C /usr/local -xzf go1.25.6.linux-${TARGETARCH}.tar.gz && \
    rm go1.25.6.linux-${TARGETARCH}.tar.gz && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/usr/local/go/bin:${PATH}"
ENV GOPATH="/go"
ENV PATH="${GOPATH}/bin:${PATH}"

# Install required tools
RUN apt-get update && \
    apt-get install -y gettext bash gawk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install goimports
RUN go install golang.org/x/tools/cmd/goimports@latest

# Set up working directories
WORKDIR /workspace

# Copy build script
COPY build.sh /workspace/build.sh
RUN chmod +x /workspace/build.sh

# Copy user's baml_src
COPY baml_src /workspace/baml_src

# Copy baml_rest sources
COPY baml_rest /workspace/baml_rest

{{- if .bamlSource }}
# Copy built CFFI library and CLI from Rust stage
COPY --from=cffi-builder /baml_engine/target/release/libbaml_cffi.so /workspace/custom_baml_lib.so
COPY --from=cffi-builder /baml_engine/target/release/baml-cli /usr/local/bin/baml-cli

# Assemble Go module for replace directive (go.mod is at repo root, Go source under engine/)
COPY baml_go.mod /workspace/custom_baml_go_lib/go.mod
COPY baml_go.sum* /workspace/custom_baml_go_lib/
COPY --from=cffi-builder /baml_engine/language_client_go /workspace/custom_baml_go_lib/engine/language_client_go
RUN touch /workspace/custom_baml_go_lib/.provided
{{- else }}
{{- if not .noCustomBamlLib }}
# Copy custom BAML lib if provided (wildcard allows this to be optional)
COPY custom_baml_lib.so* /workspace/
{{- end }}

# Copy custom BAML Go lib directory (always exists, may be empty)
COPY custom_baml_go_lib /workspace/custom_baml_go_lib
{{- end }}

# Set build environment variables
{{- if .bamlSource }}
ENV BAML_CLI_PATH="/usr/local/bin/baml-cli"
{{- end }}
ENV BAML_VERSION="{{ .bamlVersion }}"
ENV ADAPTER_VERSION="{{ .adapterVersion }}"
ENV USER_CONTEXT_PATH="/workspace"
ENV OUTPUT_PATH="/output/baml-rest"
ENV BAML_CACHE_DIR="/baml-cache-build"
{{- if .keepSource }}
ENV KEEP_SOURCE="true"
ENV KEEP_SOURCE_DIR="{{ .keepSource }}"
{{- end }}
{{- if .debugBuild }}
ENV DEBUG_BUILD="true"
{{- end }}

# Run build
{{- if .noCacheMount }}
RUN /workspace/build.sh
{{- else }}
# build.sh will temporarily override BAML_CACHE_DIR to use a version-specific location in the cache mount,
# then copy the cached shared library to BAML_CACHE_DIR at the end
RUN --mount=type=cache,target=/cache \
    /workspace/build.sh
{{- end }}

# Final stage: Minimal Debian image
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y ca-certificates tzdata bash && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /

# Copy binary from builder
COPY --from=builder /output/baml-rest /baml-rest

# Copy BAML cache from builder
COPY --from=builder /baml-cache-build /baml-cache

{{- if .keepSource }}
# Copy generated source files from builder for inspection (keep-source flag enabled)
COPY --from=builder {{ .keepSource }} {{ .keepSource }}
{{- end }}

ENV BAML_LOG=off
ENV BAML_CACHE_DIR=/baml-cache

ENTRYPOINT ["/baml-rest", "serve"]
