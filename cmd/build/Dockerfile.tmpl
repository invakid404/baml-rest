FROM node:22-alpine AS client

RUN apk add --no-cache gettext bash

WORKDIR /baml

COPY baml_src baml_src

COPY clients.baml.template clients.baml.template
ENV OUTPUT_DIR="../baml_rest_generated"
ENV BAML_VERSION="{{ .bamlVersion }}"
RUN cat clients.baml.template | envsubst | tee baml_src/baml_rest_client.baml

RUN npx @boundaryml/baml@{{ .bamlVersion }} generate

FROM golang:latest AS build

RUN go install golang.org/x/tools/cmd/goimports@latest

WORKDIR /build
COPY baml_rest baml_rest

WORKDIR /build/baml_rest

COPY --from=client /baml/baml_rest_generated/baml_client baml_client
RUN go run cmd/introspect/main.go

RUN gofmt -w . && goimports -w .

RUN go get github.com/boundaryml/baml@{{ .bamlVersion }}
RUN go mod tidy

ENV BAML_CACHE_DIR=/baml-cache

RUN go build -o baml-rest cmd/serve/main.go
RUN ./baml-rest

FROM debian:latest

RUN apt-get update && \
    apt-get install -y ca-certificates tzdata bash && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /
COPY --from=build /build/baml_rest/baml-rest /baml-rest
COPY --from=build /baml-cache /baml-cache

ENV BAML_CACHE_DIR=/baml-cache

ENTRYPOINT ["/baml-rest"]