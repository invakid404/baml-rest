# Builder stage: Node.js + Go combined environment
FROM node:22-bookworm AS builder

# Install Go (multi-architecture support)
ARG TARGETARCH
RUN apt-get update && \
    apt-get install -y wget git ca-certificates && \
    wget -q https://go.dev/dl/go1.25.5.linux-${TARGETARCH}.tar.gz && \
    tar -C /usr/local -xzf go1.25.5.linux-${TARGETARCH}.tar.gz && \
    rm go1.25.5.linux-${TARGETARCH}.tar.gz && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

ENV PATH="/usr/local/go/bin:${PATH}"
ENV GOPATH="/go"
ENV PATH="${GOPATH}/bin:${PATH}"

# Install required tools
RUN apt-get update && \
    apt-get install -y gettext bash gawk && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install goimports
RUN go install golang.org/x/tools/cmd/goimports@latest

# Set up working directories
WORKDIR /workspace

# Copy build script
COPY build.sh /workspace/build.sh
RUN chmod +x /workspace/build.sh

# Copy user's baml_src
COPY baml_src /workspace/baml_src

# Copy baml_rest sources
COPY baml_rest /workspace/baml_rest

# Set build environment variables
ENV BAML_VERSION="{{ .bamlVersion }}"
ENV ADAPTER_VERSION="{{ .adapterVersion }}"
ENV USER_CONTEXT_PATH="/workspace"
ENV OUTPUT_PATH="/output/baml-rest"
ENV BAML_CACHE_DIR="/baml-cache-build"
{{- if .keepSource }}
ENV KEEP_SOURCE="true"
ENV KEEP_SOURCE_DIR="{{ .keepSource }}"
{{- end }}

# Run build with unified cache mount
# build.sh will temporarily override BAML_CACHE_DIR to use a version-specific location in the cache mount,
# then copy the cached shared library to BAML_CACHE_DIR at the end
RUN --mount=type=cache,target=/cache \
    /workspace/build.sh

# Final stage: Minimal Debian image
FROM debian:bookworm-slim

RUN apt-get update && \
    apt-get install -y ca-certificates tzdata bash && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /

# Copy binary from builder
COPY --from=builder /output/baml-rest /baml-rest

# Copy BAML cache from builder
COPY --from=builder /baml-cache-build /baml-cache

{{- if .keepSource }}
# Copy generated source files from builder for inspection (keep-source flag enabled)
COPY --from=builder {{ .keepSource }} {{ .keepSource }}
{{- end }}

ENV BAML_LOG=off
ENV BAML_CACHE_DIR=/baml-cache

ENTRYPOINT ["/baml-rest"]
