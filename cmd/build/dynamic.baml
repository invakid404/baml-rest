// DO NOT MODIFY - Auto-generated by baml-rest
// This file provides the dynamic prompt functionality

class Baml_Rest_CacheControl {
  cache_type string @alias("type")  // "ephemeral" - aliased because 'type' is reserved
}

class Baml_Rest_MessageMetadata {
  cache_control Baml_Rest_CacheControl?  // Anthropic prompt caching
  // Future metadata fields go here
}

// A single content part within a multi-part message.
// Exactly one field should be set per part.
// Field names avoid BAML type keywords (image, audio, pdf, video).
class Baml_Rest_ContentPart {
  text string?
  img image?
  aud audio?
  doc pdf?
  vid video?
  output_format bool?
}

class Baml_Rest_Message {
  role string
  content string?                       // Legacy: plain text content
  parts Baml_Rest_ContentPart[]?        // Multi-part content with media support
  metadata Baml_Rest_MessageMetadata?
}

class Baml_Rest_DynamicOutput {
  @@dynamic
}

// Placeholder client - callers MUST provide client_registry.primary
// For cache_control to work, include allowed_role_metadata in client options
client<llm> Baml_Rest_DynamicClient {
  provider "openai"
  options {
    model "gpt-4o-mini"
  }
}

function Baml_Rest_Dynamic(messages: Baml_Rest_Message[]) -> Baml_Rest_DynamicOutput {
  client Baml_Rest_DynamicClient
  // Whitespace control (-%} / {%-) is used throughout to prevent Jinja
  // control flow from injecting blank lines into the rendered prompt.
  prompt #"
    {%- for m in messages %}
      {%- if m.metadata and m.metadata.cache_control %}{{ _.role(m.role, cache_control=m.metadata.cache_control) }}{% else %}{{ _.role(m.role) }}{% endif -%}
      {%- if m.parts -%}
        {%- for p in m.parts -%}
          {%- if p.text %}{{ p.text }}{% elif p.img %}{{ p.img }}{% elif p.aud %}{{ p.aud }}{% elif p.doc %}{{ p.doc }}{% elif p.vid %}{{ p.vid }}{% elif p.output_format %}{{ ctx.output_format }}{% endif -%}
        {%- endfor -%}
      {%- elif m.content %}{{ m.content | replace("{output_format}", ctx.output_format) }}{% endif -%}
    {%- endfor %}
  "#
}
